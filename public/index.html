<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZM 数据统计</title>
    <link rel="stylesheet" href="style.css?v=5">
    <link rel="stylesheet" href="assets/css/launcher.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Umami Analytics -->
    <script defer src="http://154.222.30.217:2345/script.js"
        data-website-id="f4036759-b32e-4ebb-b0d8-3cbb1208fab3"></script>
    <!-- HTML2Canvas for generating share image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
    <div id="bg-layer"></div>
    <div id="app">
        <!-- Login View -->
        <div id="login-view" class="view">
            <div class="launcher-frame">
                <div class="launcher-card">

                    <div class="launcher-header-tabs">
                        <div class="launcher-tab active" data-launcher-tab="info">工具说明</div>
                        <div class="launcher-tab" data-launcher-tab="updates">更新日志</div>
                        <div class="launcher-tab" data-launcher-tab="security">关于盗号</div>
                        <div class="launcher-tab" data-launcher-tab="repo">开源仓库</div>
                        <div class="launcher-tab" data-launcher-tab="channel">加入频道</div>
                    </div>

                    <div class="launcher-body">
                        <!-- Left Info Side -->
                        <div class="launcher-info-side">
                            <!-- Tool Info Panel -->
                            <div id="panel-info" class="info-content-panel active">
                                <h3>关于本工具</h3>
                                <div class="info-content-text">
                                    <p>本项目是一个基于 Cloudflare Workers 构建的轻量级 Web 应用，用于查看《逆战：未来》的游戏统计数据</p>
                                    <p><strong>工作原理</strong></p>
                                    <p>• QQ区：通过官方登录接口获取授权 Token (OpenID & Access Token)，安全请求游戏数据</p>
                                    <p>• 微信区：利用官方活动页接口，通过 Milo SDK 转换获得游戏 Cookie</p>
                                    <p><strong>隐私安全</strong></p>
                                    <p>所有敏感数据仅保存在您本地浏览器的缓存中。服务器仅作流量转发，不保存任何用户数据</p>
                                </div>
                            </div>

                            <!-- Updates Panel -->
                            <div id="panel-updates" class="info-content-panel">
                                <h3>更新日志</h3>
                                <div class="info-content-text">
                                    <div class="update-item">
                                        <span class="update-date">2026.02.23</span>
                                        <ul>
                                            <li>重构前端</li>
                                            <li>优化二维码加载速度与轮询稳定性</li>
                                            <li>增强移动端自适应表现</li>
                                        </ul>
                                    </div>
                                    <div class="update-item">
                                        <span class="update-date">2026.02.15</span>
                                        <ul>
                                            <li>修复部分猎场地图数据统计异常</li>
                                            <li>新增赞助者名单显示</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Security Panel -->
                            <div id="panel-security" class="info-content-panel">
                                <h3>关于盗号/封号说明</h3>
                                <div class="security-text">
                                    <div class="security-qa">
                                        <p><strong>Q: 为什么会显示异地登录？</strong><br>
                                            A: 因为本项目部署在 Cloudflare 全球边缘网络，扫码时的授权请求是通过 CF 节点转发的。这在 QQ 安全中心看来属于正常现象</p>

                                        <p><strong>Q: 源码安全吗？</strong><br>
                                            A: 项目完全开源在 GitHub，您可以随时审查每一行代码。如果您仍有顾虑，完全可以下载源码自行在本地部署运行</p>

                                        <p><strong>Q: 会有封号风险吗？</strong><br>
                                            A: 本工具仅调用官方开放的数据读取接口，不涉及任何游戏内存修改或作弊功能，与官方小程序原理一致</p>

                                        <p style="color: #ef4444; font-weight: bold; margin-top: 2rem;">
                                            长个嘴一张一闭就是要盗号封号，开源你是完全看不到，等你老了等我给你推销保健品
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Repo Panel -->
                            <div id="panel-repo" class="info-content-panel">
                                <h3>开源仓库</h3>
                                <div class="repo-content">
                                    <p>本项目已在 GitHub 完全开源</p>
                                    <div style="margin-top: 20px;">
                                        <a href="https://github.com/HaMan412/NZM" target="_blank"
                                            class="launcher-btn primary">
                                            前往 GitHub 仓库
                                        </a>
                                    </div>
                                    <p style="font-size: 0.85rem; color: #94a3b8; margin-top: 15px;">
                                        如果您觉得好用，可以下载源码在自己的服务器 or 本地进行私有化部署
                                    </p>
                                </div>
                            </div>

                            <!-- Channel Panel -->
                            <div id="panel-channel" class="info-content-panel">
                                <h3>加入频道</h3>
                                <div class="channel-content">
                                    <p>由于 QQ 群经常满员，目前先开放 Oopz 频道进行交流，后续会开多的Q群</p>
                                    <div style="margin-top: 20px;">
                                        <a href="https://oopz.cn/i/snhcix" target="_blank" class="launcher-btn purple">
                                            加入 Oopz 频道
                                        </a>
                                    </div>
                                    <div class="channel-tips"
                                        style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                        <p style="color: #f59e0b; font-weight: bold; margin-bottom: 5px;">进群必看：</p>
                                        <p style="font-size: 0.85rem; color: #94a3b8;">
                                            进频道后请务必查看「常见问题」，不要提问QA中已有的问题</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Login Side -->
                        <div class="launcher-login-side">
                            <div class="launcher-login-header">
                                <img src="images/logo_gcd.png" style="height: 54px;" alt="Logo">
                                <span class="season-tag">S1 鬼吹灯赛季</span>
                            </div>

                            <!-- Login Method Tabs -->
                            <div class="launcher-method-tabs">
                                <div id="method-qq-tab" class="method-tab active">QQ登录</div>
                                <div id="method-wechat-tab" class="method-tab">微信登录</div>
                            </div>

                            <!-- QQ Login Container -->
                            <div id="qr-login-container" class="login-box active">
                                <div class="qr-wrapper">
                                    <img id="qr-img" src="">
                                    <div id="qr-loading" class="qr-state">正在获取...</div>
                                    <div id="qr-overlay" class="qr-state overlay" style="display:none;">
                                        <span class="expired-icon">⚠️</span>
                                        <span
                                            style="font-size:0.9rem; font-weight:600; color:#ef4444; margin-bottom:10px;">二维码已过期</span>
                                        <button id="qq-refresh-btn" class="refresh-action-btn">点击刷新</button>
                                    </div>
                                </div>
                                <div class="login-status-area">
                                    <div id="qr-status" class="login-status-text"></div>
                                </div>
                            </div>

                            <!-- WeChat Login Container -->
                            <div id="wechat-login-container" class="login-box">
                                <div class="qr-wrapper">
                                    <img id="wx-qr-img" src="">
                                    <div id="wx-qr-loading" class="qr-state">正在获取...</div>
                                    <div id="wx-qr-overlay" class="qr-state overlay" style="display:none;">
                                        <span class="expired-icon">⚠️</span>
                                        <span
                                            style="font-size:0.9rem; font-weight:600; color:#ef4444; margin-bottom:10px;">二维码已过期</span>
                                        <button id="wx-refresh-btn" class="refresh-action-btn">点击刷新</button>
                                    </div>
                                </div>
                                <div class="login-status-area">
                                    <div id="wx-qr-status" class="login-status-text"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats View -->
        <div id="stats-view" class="view hidden stats-main-layout">
            <!-- Sidebar -->
            <aside class="stats-sidebar">
                <div class="sidebar-top">
                    <div
                        style="display: flex; flex-direction: column; align-items: center; padding: 20px 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); margin-bottom: 12px;">
                        <img src="images/logo_gcd.png" alt="赛季图标"
                            style="width: 64px; height: 64px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);">
                        <div style="color: #e2e8f0; font-size: 1.3rem; font-weight: bold; letter-spacing: 1px;">逆战未来数据统计
                        </div>
                    </div>
                    <nav class="sidebar-nav">
                        <div class="nav-item active animate-float-in" style="animation-delay: 0s;"
                            onclick="switchStatsTab('stats')">数据统计</div>
                        <div class="nav-item animate-float-in" style="animation-delay: 0.05s;"
                            onclick="switchStatsTab('history')">历史战绩</div>
                        <div class="nav-item animate-float-in" style="animation-delay: 0.1s;"
                            onclick="switchStatsTab('collection')">游戏图鉴</div>
                        <div class="nav-item animate-float-in" style="animation-delay: 0.15s;"
                            onclick="switchStatsTab('sponsors')">打赏列表
                        </div>
                        <div class="nav-item animate-float-in" style="animation-delay: 0.2s;" id="nav-maps"
                            onclick="switchStatsTab('maps')">地图图片</div>
                    </nav>
                </div>

                <div class="sidebar-mid">
                    <!-- Mid area can be used for other navigation or left empty -->
                </div>

                <div class="sidebar-bottom">
                    <div class="sidebar-actions">
                        <div id="logout-btn" class="sidebar-action"
                            style="margin-top: -15px; margin-bottom: 8px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; width: 260px; transform: translateX(-10px); font-weight: bold;">
                            解除同步</div>
                    </div>
                    <div class="donation-card animate-float-in" style="animation-delay: 0.2s; text-align: center;">
                        <img src="images/donate-wechat.png" alt="赞赏码"
                            style="width: 260px; height: 260px; border-radius: 12px; display: block; margin: 0 auto; margin-bottom: 5px; transform: translateX(-10px); box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                        <p
                            style="font-size: 0.75rem; color: #94a3b8; line-height: 1.5; margin: 0 auto; width: 260px; transform: translateX(-10px);">
                            "维护不易，若有帮助到你，可以在条件允许的情况下请作者喝杯咖啡~ 我会在官方小程序优化前一直维护哒~"</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="stats-container">

                <div class="stats-master-card stats-tab-content">
                    <div id="loading" class="loading-spinner hidden">
                        <div class="spinner"></div>
                        <p>正在同步数据...</p>
                    </div>

                    <div id="error-msg" class="error-banner hidden"></div>

                    <div id="stats-tab">
                        <div id="stats-content" class="hidden">

                            <!-- Left Data Column -->
                            <div class="stats-left-column">


                                <!-- Section 1: Official Totals -->
                                <div class="master-section">
                                    <div class="master-section-header animate-float-in" style="animation-delay: 0.05s;">
                                        <div class="master-indicator"></div>
                                        <div class="master-title">官方历史数据 (小程序)</div>
                                        <div class="header-actions"
                                            style="margin-left: auto; display: flex; gap: 12px;">
                                            <button id="refresh-btn" class="header-action-btn">刷新状态</button>
                                            <button id="gen-share-img-btn" class="header-action-btn">生成分享图</button>
                                        </div>
                                    </div>
                                    <div class="stats-grid-row">
                                        <div class="matte-card animate-float-in" style="animation-delay: 0.1s;">
                                            <span class="label">僵尸猎场总场次</span>
                                            <span id="off-hunt-games" class="value">-</span>
                                        </div>
                                        <div class="matte-card animate-float-in" style="animation-delay: 0.14s;">
                                            <span class="label">塔防总场次</span>
                                            <span id="off-tower-games" class="value">-</span>
                                        </div>
                                        <div class="matte-card animate-float-in" style="animation-delay: 0.18s;">
                                            <span class="label">机甲排位总场次</span>
                                            <span id="off-rank-games" class="value">-</span>
                                        </div>
                                        <div class="matte-card animate-float-in" style="animation-delay: 0.22s;">
                                            <span class="label">时空追猎总场次</span>
                                            <span id="off-chase-games" class="value">-</span>
                                        </div>
                                        <div class="matte-card animate-float-in" style="animation-delay: 0.26s;">
                                            <span class="label">在线时长</span>
                                            <span id="off-play-time" class="value">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section 2: Recent 30 Days -->
                                <div class="master-section">
                                    <div class="master-section-header animate-float-in" style="animation-delay: 0.25s;">
                                        <div class="master-indicator"></div>
                                        <div class="master-title">近期战绩统计 <span
                                                class="master-subtitle">(最近30天/100场)</span>
                                        </div>
                                    </div>
                                    <div class="stats-grid-row recent-records">
                                        <div class="matte-card animate-float-in" style="animation-delay: 0.3s;">
                                            <span class="label">近期场次</span>
                                            <span id="recent-games" class="value">-</span>
                                        </div>
                                        <div class="matte-card animate-float-in" style="animation-delay: 0.35s;">
                                            <span class="label">近期通关率</span>
                                            <span id="recent-win" class="value">-</span>
                                        </div>
                                        <div class="matte-card animate-float-in" style="animation-delay: 0.4s;">
                                            <span class="label">场均综合评分</span>
                                            <span id="recent-dmg" class="value">-</span>
                                        </div>
                                        <div class="matte-card animate-float-in" style="animation-delay: 0.45s;">
                                            <span class="label">场均BOSS伤害 (近10场)</span>
                                            <span id="recent-boss" class="value">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section 3: Mode Stats -->
                                <div class="master-section">
                                    <div class="master-section-header animate-float-in" style="animation-delay: 0.5s;">
                                        <div class="master-indicator"></div>
                                        <div class="master-title">近期模式统计 (不含排位)</div>
                                    </div>
                                    <div id="mode-stats" class="stats-grid-row recent-analysis">
                                        <!-- JS rendered cards -->
                                    </div>
                                </div>

                                <!-- Section 4: Map Distribution -->
                                <div class="master-section">
                                    <div class="master-section-header animate-float-in" style="animation-delay: 0.65s;">
                                        <div class="master-indicator"></div>
                                        <div class="master-title">近期地图详情 <span
                                                class="master-subtitle">(近30天/100场场次分布)</span>
                                        </div>
                                    </div>
                                    <div id="map-stats" class="stats-grid-row map-distribution">
                                        <!-- JS rendered cards -->
                                    </div>
                                </div>
                            </div><!-- /Left Data Column -->

                            <!-- Right Data Column (Fragments) -->
                            <div class="stats-right-column">
                                <div class="master-section">
                                    <div class="master-section-header animate-float-in" style="animation-delay: 0.3s;">
                                        <div class="master-indicator"></div>
                                        <div class="master-title">武器碎片</div>
                                    </div>
                                    <div id="fragment-list" class="fragment-list-container">
                                        <!-- JS populated fragments -->
                                    </div>
                                </div>
                            </div><!-- /Right Data Column -->

                        </div>
                    </div> <!-- /#stats-tab -->

                    <!-- Collection Tab Content -->
                    <div id="collection-tab" class="hidden" style="width:100%;">
                        <div class="stats-left-column">
                            <div class="master-section">
                                <div class="master-section-header animate-float-in"
                                    style="animation-delay: 0.1s; display: flex; align-items: center;">
                                    <div class="master-indicator"></div>
                                    <div class="master-title" style="margin-right: 20px;">我的图鉴</div>
                                    <div class="collection-tabs" style="display: flex; gap: 10px;">
                                        <button class="collection-tab-btn active"
                                            onclick="switchCollectionTab('weapons', this)"
                                            style="background: var(--card-bg); border: 1px solid var(--accent); color: var(--accent); padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">武器图鉴</button>
                                        <button class="collection-tab-btn" onclick="switchCollectionTab('traps', this)"
                                            style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #94a3b8; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">陷阱图鉴</button>
                                    </div>
                                </div>
                                <div id="weapon-grid" class="stats-grid-row"></div>
                                <div id="trap-grid" class="stats-grid-row hidden" style="margin-top:0;"></div>
                                <script>
                                    function switchCollectionTab(target, btn) {
                                        document.querySelectorAll('.collection-tab-btn').forEach(b => {
                                            b.style.borderColor = 'rgba(255,255,255,0.1)';
                                            b.style.color = '#94a3b8';
                                            b.classList.remove('active');
                                        });
                                        btn.style.borderColor = 'var(--accent)';
                                        btn.style.color = 'var(--accent)';
                                        btn.classList.add('active');

                                        if (target === 'weapons') {
                                            document.getElementById('weapon-grid').classList.remove('hidden');
                                            document.getElementById('trap-grid').classList.add('hidden');
                                        } else {
                                            document.getElementById('weapon-grid').classList.add('hidden');
                                            document.getElementById('trap-grid').classList.remove('hidden');
                                        }
                                    }
                                </script>
                            </div>
                        </div>
                    </div>

                    <!-- History Tab Content -->
                    <div id="history-tab" class="hidden" style="width:100%;">
                        <div class="stats-left-column">
                            <div class="master-section">
                                <div class="master-section-header animate-float-in" style="animation-delay: 0.1s;">
                                    <div class="master-indicator"></div>
                                    <div class="master-title">历史对局记录</div>
                                    <div id="page-info" class="master-subtitle" style="margin-left:auto; opacity:1;">页码:
                                        1/1</div>
                                </div>
                                <div id="match-history" class="match-history-list">
                                    <!-- JS populated matches -->
                                </div>
                                <div class="history-pagination animate-float-in" style="animation-delay: 0.15s;">
                                    <button id="prev-page" class="matte-btn">上一页</button>
                                    <div class="page-jump-group">
                                        <span class="page-jump-label">跳转到</span>
                                        <input id="page-jump-input" type="number" min="1" class="page-jump-input"
                                            placeholder="页码">
                                        <button id="page-jump-btn" class="matte-btn">跳转</button>
                                    </div>
                                    <button id="next-page" class="matte-btn">下一页</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sponsors Tab Content -->
                    <div id="sponsors-tab" class="hidden" style="width:100%;">
                        <div class="master-section" style="width:100%;">
                            <div class="master-section-header animate-float-in"
                                style="justify-content:space-between; animation-delay: 0.1s;">
                                <div style="display:flex; align-items:center; gap:0.75rem;">
                                    <div class="master-indicator" style="background:#ff69b4;"></div>
                                    <div class="master-title" style="color:#ff69b4;">打赏列表</div>
                                </div>
                                <div style="display:flex; gap:16px;">
                                    <button id="prev-sponsor-btn"
                                        style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:var(--text-main); cursor:pointer; padding:6px 16px; border-radius:4px; font-size:0.85rem; transition:0.2s;">上一页</button>
                                    <button id="next-sponsor-btn"
                                        style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:var(--text-main); cursor:pointer; padding:6px 16px; border-radius:4px; font-size:0.85rem; transition:0.2s;">下一页</button>
                                </div>
                            </div>
                            <div id="sponsor-list"
                                style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:1.25rem; align-items:stretch;">
                                <!-- JS populated sponsors -->
                            </div>
                        </div>
                    </div>

                    <!-- Maps Tab -->
                    <div id="maps-tab" class="hidden" style="width:100%;">
                        <div class="master-section" style="width:100%;">
                            <div class="master-section-header animate-float-in"
                                style="justify-content:space-between; animation-delay: 0.1s;">
                                <div style="display:flex; align-items:center; gap:0.75rem;">
                                    <div class="master-indicator" style="background:#10b981;"></div>
                                    <div class="master-title" style="color:#10b981;">官方地图图鉴
                                        <span
                                            style="font-size: 0.85rem; color: #9ca3af; font-weight: normal; margin-left: 12px; opacity: 0.8;">素材来源：逆战未来工具箱小程序</span>
                                    </div>
                                </div>
                            </div>
                            <div id="maps-list"
                                style="display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:1.25rem; align-items:stretch; padding-top: 1rem;">
                                <!-- JS populated maps -->
                            </div>
                        </div>
                    </div>

                </div> <!-- End .stats-master-card -->
            </main>
        </div>
    </div><!-- /#app -->
    <script type="module" src="assets/js/main.js"></script>
</body>

</html>